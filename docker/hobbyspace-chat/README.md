# DEV-Сборка для разработки

Docker Compose сборка для локальной разработки Tinode чата.

## Структура

- **server.conf** - конфигурация для сервера (с переменными окружения)
- **tinode_db.conf** - конфигурация инициализации БД (с переменными окружения)
- **.env** - переменные окружения (безопасно для коммита в dev-окружении)

## Сервисы

### 1. chatdb
PostgreSQL база данных. Использует переменные из `.env`:
- `DB_NAME` - имя базы данных
- `DB_LOGIN` - пользователь БД
- `DB_PASSWORD` - пароль БД

Порт БД не пробрасывается наружу, доступен только внутри Docker сети.

### 2. dbinit
Одноразовый контейнер для инициализации БД:
- Собирает `tinode-db` из исходников с поддержкой PostgreSQL
- Подставляет переменные окружения в `tinode_db.conf`
- Запускает инициализацию БД
- Создает root пользователя с паролем из `ROOT_USER_PASSWORD`

Запускается автоматически после готовности `chatdb` и завершает работу после выполнения.

### 3. chatserver
Сервер Tinode:
- Собирает сервер из исходников с поддержкой PostgreSQL
- Подставляет переменные окружения в `server.conf`
- Запускает сервер

Порты:
- `6060` - HTTP/WebSocket API
- `16060` - gRPC API

## Использование

### Запуск

```bash
cd docker/hobby-space
docker-compose up --build
```

### Остановка

```bash
docker-compose down
```

### Остановка с удалением данных БД

```bash
docker-compose down -v
```

### Пересборка после изменений в коде

```bash
docker-compose build --no-cache
docker-compose up
```

### Просмотр логов

```bash
# Все сервисы
docker-compose logs -f

# Конкретный сервис
docker-compose logs -f chatserver
docker-compose logs -f dbinit
docker-compose logs -f chatdb
```

## Переменные окружения

Все переменные определены в файле `.env`:

- `API_KEY` - API ключ для клиентов
- `API_KEY_SALT` - соль для подписи API ключей
- `ROOT_USER_PASSWORD` - пароль для root пользователя
- `TOKEN_KEY` - ключ для генерации токенов аутентификации
- `DB_NAME` - имя базы данных
- `DB_LOGIN` - пользователь БД
- `DB_PASSWORD` - пароль БД
- `UID_KEY` - ключ для шифрования ID пользователей и топиков

## Важно

⚠️ **Это DEV-окружение!** Файл `.env` содержит тестовые значения и безопасен для коммита только в dev-окружении.

Для production:
1. Сгенерируйте новые ключи для всех секретных значений
2. НЕ коммитьте `.env` с production значениями
3. Используйте секреты Docker или внешние системы управления секретами
