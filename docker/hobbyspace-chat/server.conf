// The JSON comments are somewhat brittle. Don't try anything too fancy.
{
  "listen": ":6060",

  // Base URL path for serving streaming and large file API calls.
  // Can be overridden from the command line, see option --api_path.
  "api_path": "/",

  // Cache-Control header for static content in seconds. 39600 is 11 hours.
  "cache_control": 39600,

  // If true, do not attempt to negotiate websocket per message compression (RFC 7692.4).
  // It should be disabled (set to true) if you are using MSFT IIS as a reverse proxy.
  "ws_compression_disabled": false,

  // URL path for mounting the directory with static files.
  "static_mount": "/",

  // TCP host:port or unix:/path/to/socket to listen for gRPC clients.
  // Leave blank to disable gRPC support.
  // Could be overridden from the command line with --grpc_listen.
  "grpc_listen": ":16060",

  // Enable handling of gRPC keepalives https://github.com/grpc/grpc/blob/master/doc/keepalive.md
  // This sets server's GRPC_ARG_KEEPALIVE_TIME_MS to 60 seconds instead of the default 2 hours.
  "grpc_keepalive_enabled": true,

  // Salt for signing API key. 32 random bytes base64-encoded. Use 'keygen' tool (included in this
  // distro) to generate the API key and the salt.
  "api_key_salt": "${API_KEY_SALT}",

  // Maximum message size allowed from the clients in bytes (131072 = 128KB).
  // Media files with sizes greater than this limit are sent out of band.
  // Don't change this limit to a much higher value because it would likely cause failures:
  // * on Android & iOS due to a limit on the SQLite cursor window size;
  // * on the server-side with MySQL adapter due to the limit on the sort buffer size.
  "max_message_size": 131072,

  // Maximum number of subscribers per group topic.
  "max_subscriber_count": 128,

  // Maximum number of indexable tags per topic or user.
  "max_tag_count": 16,

  // If true, ordinary users cannot delete their accounts.
  "permanent_accounts": false,

  // URL path for exposing runtime stats. Disabled if the path is blank or "-".
  // Could be overriden from the command line with --expvar.
  "expvar": "/debug/vars",

  // URL path for server's internal status, useful when debugging.
  // Do not use this URL for docker status checks and some such. It's not a health check,
  // it is a debug endpoint. Disabled if the path is blank or "-". Could be overriden
  // from the command line with --server_status.
  // "server_status": "/debug/status",

  // Read IP address of the client from the HTTP header 'X-Forwarded-For'.
  // Useful when Tinode is behind a proxy. If missing, fallback to default RemoteAddr.
  "use_x_forwarded_for": true,

  // Add X-Frame-Options to HTTP response headers. It should be one of "DENY", "SAMEORIGIN",
  // "-" (disabled). If the option is missing then it's treated as SAMEORIGIN.
  "x_frame_options": "SAMEORIGIN",

  // 2-letter country code to assign to sessions by default when the country isn't specified
  // by the client explicitly and it's impossible to infer it.
  // If missing, the server will default to "US".
  "default_country_code": "",

  // Permit hard-deleting messages in p2p topics for both participants.
  // If it's set to 'false' then the message is only deleted for the peer who issued the command.
  // If it's 'true' then the message is deleted completely by either participant.
  // Changing the value affects the ability to hard-delete (the added or removed the D permission)
  // only for new topics going forward.
  "p2p_delete_enabled": true,

  // The maximum age of a message in seconds when it can be deleted by users with the 'D' permission.
  // E.g. 600 means messages up to 10 minutes old can be deleted, older than that cannot be deleted.
  // Missing or 0 means no age limit.
  // Does not affect topic owners: owners can delete any message.
  "msg_delete_age": 600,

  // Globally unique namespace. This is a special tag namespace which is used to store
  // aliases of the user. The alias is a tag which is not a valid Tinode user ID.
  "alias_tag": "alias",

  // Large media/blob handlers: large files/images included in messages.
  "media": {
    // The name of the media handler to use.
    "use_handler": "fs",
    // Maximum size of uploaded file (8MB here for testing, maybe increase to 100MB = 104857600 in prod)
    "max_size": 8388608,
    // Garbage collection periodicity in seconds: unused or abandoned uploads are deleted.
    "gc_period": 60,
    // The number of unused/abandoned entries to delete in one pass.
    "gc_block_size": 100,
    // Configurations of individual handlers.
    "handlers": {
      // File system storage.
      "fs": {
        // File system location to store uploaded files. In case of a cluster it
        // must be accessible by all cluster members, i.e. a network drive like https://www.samba.org/
        "upload_dir": "uploads",
        // Cache-Control header to use for uploaded files. 86400 seconds = 24 hours.
        "cache_control": "max-age=86400",
        // Origin URLs allowed to download/upload files, e.g. ["https://www.example.com", "http://example.com", "https://*.example.com", "http://*.*.example.com"].
        // Not necessary in most cases.
        // "cors_origins": ["*"]
      },
      // Amazon AWS S3 storage.
      // See detailed explanation at https://pkg.go.dev/github.com/aws/aws-sdk-go/aws#Config
      "s3":{
        // Use AWS console to get Access Key ID and Secret Access Key.
        // https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/
        "access_key_id": "your_s3_access_key_id",
        "secret_access_key": "your_s3_secret_access_key",
        // Region where the bucket is hosted.
        "region": "s3 region, like us-east-2",
        // Name of the S3 bucket.
        "bucket": "your_s3_bucket_name",
        // Set this to `true` to disable SSL when sending requests. Defaults to `false`.
        "disable_ssl": false,
        // Set this to `true` to force the request to use path-style addressing,
        // i.e., `http://s3.amazonaws.com/BUCKET/KEY`. By default, the S3 client
        // will use virtual hosted bucket addressing when possible
        // (`http://BUCKET.s3.amazonaws.com/KEY`).
        "force_path_style": false,
        // An optional endpoint URL (hostname only or fully qualified URI)
        // to override the default generated endpoint, or `""` to use the default generated endpoint.
        // The endpoint can be of any S3-compatible service, such as "minio-api.x.io".
        "endpoint": "",
        // Expiration time for presigned URLs in seconds.
        "presign_ttl": 3600,
        // Cache-Control header to use for uploaded files. 86400 seconds = 24 hours.
        "cache_control": "max-age=86400",
        // Origin URLs allowed to download files, e.g. ["https://www.example.com", "http://example.com"].
        // See https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin
        "cors_origins": ["*"]
      }
    }
  },

  // TLS (httpS) configuration. Applies to both web and gRPC interfaces.
  "tls": {
    // Enable TLS.
    "enabled": false,

    // Listen for connections on this port and redirect them to HTTPS port.
    // Cannot be a Unix socket.
    "http_redirect": ":80",

    // Add Strict-Transport-Security to headers, the value signifies age.
    // Zero or negative value turns it off.
    "strict_max_age": 604800,

    // Letsencrypt configuration.
    "autocert": {
      // Location of certificates.
      "cache": "/etc/letsencrypt/live/your.domain.here",

      // Contact address for this installation. LetsEncrypt will send
      // messages to this address in case of problems. Replace with your
      // own address or remove this line.
      "email": "noreply@example.com",

      // Domains served. Replace with your own domain name.
      "domains": ["whatever.example.com"]
    },

    // If "autocert" config is not defined, read static certificates from
    // these locations. Ignored if "autocert" is defined.
    "cert_file": "/etc/httpd/conf/your.domain.crt",
    "key_file": "/etc/httpd/conf/your.domain.key"
  },

  // Authentication configuration.
  "auth_config": {
    // Optional mapping of externally-visible authenticator names to internal names.
    // For example use ["my-auth:basic", "basic:"] to rename "basic" authenticator to
    // "my-auth" and make "basic" unaccessible by the old name. If you want to use REST-auth, then
    // the config is ["basic:rest", "rest:"].
    // Default is identity mapping.
    "logical_names": ["basic:"],  // Скрываем basic от обычных пользователей, но оставляем доступным для root через gRPC

    // Basic (login + password) authentication.
    "basic": {
      // Add 'auth-name:username' to tags making user discoverable by username.
      "add_to_tags": true,
      // The minimum length of a login in unicode runes, i.e. "登录" is length 2, not 6.
      // The maximum length is 32 and it cannot be changed.
      "min_login_length": 4,
      // The minimum length of a password in unicode runes, "пароль" is length 6, not 12.
      // There is no limit on maximum length, but MySQL & PgSQL adapters have a limit of 32 bytes.
      "min_password_length": 6
    },

    // Token authentication
    "token": {
      // Lifetime of a security token in seconds. 1209600 = 2 weeks.
      "expire_in": 1209600,

      // Serial number of the token. Can be used to invalidate all issued tokens at once.
      "serial_num": 1,

      // Secret key (HMAC salt) for signing the tokens. Generate your own then keep it secret.
      // Any 32 random bytes base64 encoded.
      //
      // === IMPORTANT ===
      //
      // CHANGE IT IN PRODUCTION!!! Otherwise anyone will be able to log in
      // to your server without the password. It's just random base64-encoded bytes, use any suitable
      // means to get it. For example:
      // Linux/Mac:
      //    echo $(head -c 32 /dev/urandom | base64 | tr -d '\n')
      // Windows:
      //    powershell -command "[Convert]::ToBase64String((1..32|%{[byte](Get-Random -Max 256)}))"
      "key": "${TOKEN_KEY}"
    },
  },

  // Database configuration
  "store_config": {
    // XTEA encryption key for user IDs and topic names. 16 random bytes base64-encoded.
    // Generate your own and keep it secret. Otherwise your user IDs will be predictable
    // and it will be easy to spam your users.
    "uid_key": "${UID_KEY}",

    // Maximum number of results fetched in one DB call.
    "max_results": 1024,

    // DB adapter name to communicate with the DB backend.
    // Must be one of the adapters from the list below.
    "use_adapter": "postgres",

    // Configurations of individual adapters.
    "adapters": {
      // PostgreSQL configuration. See https://godoc.org/github.com/jackc/pgx#Config
      // for other possible options.
      "postgres": {
        // PostgreSQL connection settings.
        // Don't change the username before reading the FAQ!
        "User": "${DB_LOGIN}",
        "Passwd": "${DB_PASSWORD}",
        "Host": "chatdb",
        "Port": "5432",
        "DBName": "${DB_NAME}",
        "SSLMode": "disable",

        // DSN: alternative way of specifying database configuration, passed unchanged
        // to the driver. See https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING
        // "dsn": "postgresql://postgres:postgres@localhost:5432/tinode?sslmode=disable&connect_timeout=10",

        // PostgreSQL connection pool settings.
        // Maximum number of open connections to the database. Zero means unlimited.
        "max_open_conns": 50,
        // Maximum number of connections in the idle connection pool. Zero means no idle connections are retained.
        "max_idle_conns": 50,
        // Maximum amount of time a connection may be reused. Zero means unlimited.
        "conn_max_lifetime": 60,
        // Maximum amount of time waiting for a connection from the pool. Zero means no timeout.
        "sql_timeout": 10
      },
    }
  },

  // Configuration for stale account garbage collector: remove
  // stale unvalidated user accounts which have been last updated at least
  // 'gc_min_account_age' hours ago.
  "acc_gc_config": {
    "enabled": false, // main-сервис рулит аккаунтами, не нужно для нас
    // How often to run GC (seconds).
    "gc_period": 3600,
    // Number of accounts to delete in one pass.
    "gc_block_size": 10,
    // Minimum hours since account was last modified.
    "gc_min_account_age": 30
  },

  // Configuration of push notifications.
  "push": [
    {
      // Notificator which writes to STDOUT. Useful for debugging.
      "name":"stdout",
      "config": {
        "enabled": true // for dev server
      }
    },
  ],

  // Configuration for voice and video calls.
  "webrtc": {
    // Disabled. Won't work without functioning ice_servers (see below).
    "enabled": false,
    // Timeout in seconds before a video/voice call is dropped if not answered.
    "call_establishment_timeout": 30,
    // Interactive Communication Establishment (ICE) STUN and TURN server configuration for video calls.
    // You need to configure your own servers or consider https://www.metered.ca/tools/openrelay/.
    // Video calls will not work if both parties are behind NAT and no ICE servers are configured.
    "ice_servers": [
      {
        "urls": [
          "stun:stun.example.com"
        ]
      },
      {
        "username": "user-name-to-use-for-authentication-with-the-server",
        "credential": "your-password",
        "urls": [
          "turn:turn.example.com:80?transport=udp",
          "turn:turn.example.com:3478?transport=udp",
          "turn:turn.example.com:80?transport=tcp",
          "turn:turn.example.com:3478?transport=tcp",
          "turns:turn.example.com:443?transport=tcp",
          "turns:turn.example.com:5349?transport=tcp"
        ]
      }
    ],
    // An alternative way to provide STUN/TURN configuration.
    "ice_servers_file": "/path/to/ice-servers-config.json"
  },

  // Cluster-mode configuration.
  "cluster_config": {
    // Name of this node. Can be assigned from the command line as --cluster_self.
    // Empty string disables clustering.
    "self": "",

    // List of available nodes.
    "nodes": [
      // Name and TCP address of every node in the cluster. The ports 12001..12003
      // are cluster communication ports. They don't need to be exposed to end-users.
      {"name": "one", "addr":"localhost:12001"},
      {"name": "two", "addr":"localhost:12002"},
      {"name": "three", "addr":"localhost:12003"}
    ],

    // Failover config. No need to change unless you are doing something unusual.
    "failover": {
      // Failover is enabled.
      "enabled": true,
      // Time in milliseconds between heartbeats.
      "heartbeat": 100,
      // Initiate leader election when the leader is not available for this many heartbeats.
      "vote_after": 8,
      // Consider node failed when it missed this many heartbeats.
      "node_fail_after": 16
    }
  },

  // Configuration of plugins.
  "plugins": []
}
