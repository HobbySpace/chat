# Утилита для инициализации или обновления БД `tinode`

Эта утилита инициализирует базу данных `tinode` (или обновляет существующую БД с более ранней версии) и опционально загружает в нее данные. Для принудительного сброса базы данных используйте опцию командной строки `--reset=true`.

## Сборка пакета:

 - **RethinkDB**
  `go build -tags rethinkdb` или `go build -i -tags rethinkdb` для автоматической установки отсутствующих зависимостей.

 - **MySQL**
  `go build -tags mysql` или `go build -i -tags mysql` для автоматической установки отсутствующих зависимостей.

 - **MongoDB**
  `go build -tags mongodb` или `go build -i -tags mongodb` для автоматической установки отсутствующих зависимостей.

 - **PostgreSQL**
  `go build -tags postgres` или `go build -i -tags postgres` для автоматической установки отсутствующих зависимостей.


## Запуск

Запуск из командной строки.

`tinode-db [параметры]`

Параметры командной строки:
 - `--reset`: удалить базу данных, затем пересоздать ее в пустом состоянии; не имеет эффекта, если база данных не существует.
 - `--upgrade`: обновить базу данных с более ранней версии, сохраняя все данные; обязательно сделайте резервную копию БД перед обновлением.
 - `--no_init`: проверить, что база данных существует, но не создавать ее, если она отсутствует.
 - `--data=ИМЯ_ФАЙЛА`: заполнить базу данных `tinode` данными из предоставленного файла. См. [data.json](data.json).
 - `--config=ИМЯ_ФАЙЛА`: загрузить конфигурацию из ИМЯ_ФАЙЛА. Пример конфигурации включен как [tinode.conf](tinode.conf).
 - `--make_root=USER_ID`: повысить существующего пользователя до пользователя root, `USER_ID` в форме `usrAbCDef123`.
 - `--add_root=USERNAME[:PASSWORD]`: создать новый аккаунт пользователя и сделать его root; если пароль отсутствует, будет сгенерирован надежный пароль.

Опции файла конфигурации:
 - `uid_key` — это base64-кодированный 16-байтовый ключ шифрования XTEA для (слабого) шифрования ID объектов, чтобы они не выглядели последовательными. Вероятно, вы захотите использовать свой собственный ключ в продакшене.
 - `store_config.adapters.mysql` и `store_config.adapters.rethinkdb` — это разделы, специфичные для базы данных:
  - `database` — это имя базы данных для создания.
  - `addresses` — это хост и номер порта RethinkDB/MongoDB для подключения. Также может быть предоставлен массив хостов `["host1", "host2"]`.
  - `dsn` — это Data Source Name MySQL.
  - `replica_set` — это имя Replicaset MongoDB.

`uid_key` используется только если загружаются тестовые данные. Он должен совпадать с ключом продакшен-сервера и должен храниться в секрете.

Файл `data.json` по умолчанию создает шесть пользователей с именами `alice`, `bob`, `carol`, `dave`, `frank` и `tino` (пользователь чат-бота). Пароли совпадают с именами пользователей с добавлением 123, например, пользователь `alice` получает пароль `alice123`; `tino` получает случайно сгенерированный пароль. Он также создает три групповых топика и несколько peer to peer топиков. Пользователи подписаны на топики и друг на друга. Все топики случайным образом заполнены сообщениями.

Фотографии аватаров предоставлены https://www.pexels.com/ под лицензией [CC0](https://www.pexels.com/photo-license/).

## Ссылки:

* [Схема RethinkDB](https://github.com/tinode/chat/tree/master/server/db/rethinkdb/schema.md)
* [Схема MySQL](https://github.com/tinode/chat/tree/master/server/db/mysql/schema.sql)
* [Схема MongoDB](https://github.com/tinode/chat/tree/master/server/db/mongodb/schema.md)
* [Схема PostgreSQL](https://github.com/tinode/chat/tree/master/server/db/postgres/schema.sql)

